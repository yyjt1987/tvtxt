name: Sync TVBox Repository

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-tvbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Clone or update TVBox repository
        run: |
          if [ -d ".tvbox-temp" ]; then
            echo "Updating existing TVBox repository..."
            cd .tvbox-temp
            git pull origin main
          else
            echo "Cloning TVBox repository..."
            git clone https://github.com/kimwang1978/tvbox.git .tvbox-temp
          fi
      
      - name: Sync to public directory (full overwrite)
        run: |
          echo "Syncing TVBox content to public directory..."
          # 首先确保public目录存在
          mkdir -p public
          
          # 清空public目录（保留.gitignore等隐藏文件）
          find public -type f -not -name ".*" -delete
          find public -type d -not -name "." -not -path "*/.*" -exec rm -rf {} \;
          
          # 复制TVBox内容到public目录
          cp -r .tvbox-temp/* ./public/
          # 删除可能存在的.git目录（如果被复制过来了）
          rm -rf ./public/.git
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add ./public/
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync TVBox repository changes"
            git push origin main
          fi